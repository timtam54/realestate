# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: 'Build and deploy Node.js app to Azure Web App: buysel-webapp'

on:
  push:
    branches:
    - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js version
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: npm install and build
      env:
        NEXT_PUBLIC_GOOGLE_MAP_API: AIzaSyANThwic7Udj0r5ulBoPN9Dp2lSwJKOAK4
        NEXT_PUBLIC_AZUREBLOB_CONTAINER: photosdocs
        NEXT_PUBLIC_AZUREBLOB_SASTOKEN: sv=2024-11-04&ss=b&srt=sco&sp=rwdlaciytfx&se=2035-10-14T18:02:51Z&st=2025-10-14T09:47:51Z&spr=https&sig=lFOuI%2FXifw3wGShtjUcjdeQn8DenYY%2FtIrWOQ%2FCZqvo%3D
        NEXT_PUBLIC_AZUREBLOB_SASURL_BASE: https://buyselstore.blob.core.windows.net
        NEXT_PUBLIC_VAPID_PUBLIC_KEY: BIh49CHmmuAuHOPGiZdzVj-_3_dZXIEv57JNWeOibt2agftbQWpcC_kngiLQEzRKZ3T7ptb1bvGqxzu3PRkdGec
        NEXT_PUBLIC_API_URL: https://buysel.azurewebsites.net
        SESSION_SECRET: Y8jih3rwDE7U0mPwxHms0a72eBapQPNuW8NlDVsCGw8=
        JWT_SECRET: dev-jwt-secret-key-must-be-at-least-32-characters-long-for-development
        GOOGLE_CLIENT_ID: 155334538327-i07ipbgfbg95nhb0h5cfe8vu27lcek9f.apps.googleusercontent.com
        GOOGLE_CLIENT_SECRET: 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
        AZURE_AD_CLIENT_ID: fc8b4cc8-e653-4887-9bb2-21c63b3a4d59
        AZURE_AD_CLIENT_SECRET: Dnw8Q~otHIogO522Npd6KOPTTaH~zqF6aIB5Dc5U
        AZURE_AD_TENANT_ID: common
        FACEBOOK_CLIENT_ID: 1892744611304190
        FACEBOOK_CLIENT_SECRET: a4b36b640772390df34834a480c9cce4
        NEXTAUTH_URL: https://buysel-webapp.azurewebsites.net
        VAPID_PRIVATE_KEY: EKIzkxo_icPeY9CDXb5tcnAPUZl_O3lFG6J27Cu4fIA
        VAPID_PUBLIC_KEY: BIh49CHmmuAuHOPGiZdzVj-_3_dZXIEv57JNWeOibt2agftbQWpcC_kngiLQEzRKZ3T7ptb1bvGqxzu3PRkdGec
        VAPID_EMAIL: mailto:admin@buysel.com
      run: |
        npm install
        npm run build

    - name: Prepare deployment package
      run: |
        mkdir -p deploy
        cp -r .next/standalone/* deploy/
        cp -r .next/static deploy/.next/static
        cp -r public deploy/public
        cd deploy
        zip -r ../deploy.zip .

    - name: 'Deploy to Azure Web App via ZipDeploy'
      run: |
        curl -X POST \
          -u '$buysel-webapp:ttzJHzfT51BLvwk14y9kCrAGqgZxd6RFnHn3ywQ6x3AjpB0bxRg1T0L2x8zC' \
          --data-binary @deploy.zip \
          -H "Content-Type: application/zip" \
          -w "\nHTTP Status: %{http_code}\n" \
          https://buysel-webapp.scm.azurewebsites.net/api/zipdeploy
