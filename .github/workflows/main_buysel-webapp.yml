# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: 'Build and deploy Node.js app to Azure Web App: buysel-webapp'

on:
  push:
    branches:
    - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js version
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: npm install and build
      env:
        NEXT_PUBLIC_GOOGLE_MAP_API: AIzaSyANThwic7Udj0r5ulBoPN9Dp2lSwJKOAK4
        NEXT_PUBLIC_AZUREBLOB_CONTAINER: photosdocs
        NEXT_PUBLIC_AZUREBLOB_SASTOKEN: sv=2024-11-04&ss=b&srt=sco&sp=rwdlaciytfx&se=2035-10-14T18:02:51Z&st=2025-10-14T09:47:51Z&spr=https&sig=lFOuI%2FXifw3wGShtjUcjdeQn8DenYY%2FtIrWOQ%2FCZqvo%3D
        NEXT_PUBLIC_AZUREBLOB_SASURL_BASE: https://buyselstore.blob.core.windows.net
        NEXT_PUBLIC_VAPID_PUBLIC_KEY: BIh49CHmmuAuHOPGiZdzVj-_3_dZXIEv57JNWeOibt2agftbQWpcC_kngiLQEzRKZ3T7ptb1bvGqxzu3PRkdGec
        NEXT_PUBLIC_API_URL: https://buysel.azurewebsites.net
        SESSION_SECRET: Y8jih3rwDE7U0mPwxHms0a72eBapQPNuW8NlDVsCGw8=
        JWT_SECRET: dev-jwt-secret-key-must-be-at-least-32-characters-long-for-development
        GOOGLE_CLIENT_ID: 155334538327-i07ipbgfbg95nhb0h5cfe8vu27lcek9f.apps.googleusercontent.com
        GOOGLE_CLIENT_SECRET: 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
        AZURE_AD_CLIENT_ID: fc8b4cc8-e653-4887-9bb2-21c63b3a4d59
        AZURE_AD_CLIENT_SECRET: Dnw8Q~otHIogO522Npd6KOPTTaH~zqF6aIB5Dc5U
        AZURE_AD_TENANT_ID: common
        FACEBOOK_CLIENT_ID: 1892744611304190
        FACEBOOK_CLIENT_SECRET: a4b36b640772390df34834a480c9cce4
        NEXTAUTH_URL: https://buysel-webapp.azurewebsites.net
        VAPID_PRIVATE_KEY: EKIzkxo_icPeY9CDXb5tcnAPUZl_O3lFG6J27Cu4fIA
        VAPID_PUBLIC_KEY: BIh49CHmmuAuHOPGiZdzVj-_3_dZXIEv57JNWeOibt2agftbQWpcC_kngiLQEzRKZ3T7ptb1bvGqxzu3PRkdGec
        VAPID_EMAIL: mailto:admin@buysel.com
      run: |
        npm install
        npm run build

    - name: Prepare deployment package
      run: |
        echo "Checking build output..."
        ls -la .next/
        echo "Checking standalone folder..."
        ls -la .next/standalone/ || echo "No standalone folder"

        mkdir -p deploy

        # Copy standalone output
        if [ -d ".next/standalone" ]; then
          cp -r .next/standalone/. deploy/
        else
          echo "ERROR: .next/standalone not found!"
          exit 1
        fi

        # Copy static files
        mkdir -p deploy/.next
        cp -r .next/static deploy/.next/static

        # Copy public files
        cp -r public deploy/public

        echo "Deployment package contents:"
        ls -la deploy/
        echo "Checking for server.js:"
        ls -la deploy/server.js || echo "ERROR: server.js not found!"

    - name: Create deployment zip
      run: |
        cd deploy
        zip -r ../deploy.zip .
        cd ..
        ls -lh deploy.zip

    - name: Deploy to Azure Web App
      env:
        AZURE_WEBAPP_PUBLISH_PROFILE: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
      run: |
        # Extract credentials from publish profile using more compatible regex
        USERNAME=$(echo "$AZURE_WEBAPP_PUBLISH_PROFILE" | grep -o 'userName="[^"]*"' | head -1 | sed 's/userName="//;s/"//')
        PASSWORD=$(echo "$AZURE_WEBAPP_PUBLISH_PROFILE" | grep -o 'userPWD="[^"]*"' | head -1 | sed 's/userPWD="//;s/"//')

        # Debug: Check if credentials were extracted (without showing actual values)
        if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
          echo "ERROR: Failed to extract credentials from publish profile"
          echo "Username empty: $([ -z "$USERNAME" ] && echo 'yes' || echo 'no')"
          echo "Password empty: $([ -z "$PASSWORD" ] && echo 'yes' || echo 'no')"
          exit 1
        fi

        echo "Credentials extracted successfully"
        echo "Deploying to Azure Web App (this will take 2-3 minutes)..."

        # Use synchronous deployment (isAsync=false) and show progress
        HTTP_CODE=$(curl -X POST \
          -u "$USERNAME:$PASSWORD" \
          --data-binary @deploy.zip \
          -H "Content-Type: application/zip" \
          -w "%{http_code}" \
          -o deployment_response.txt \
          --max-time 600 \
          "https://buysel-webapp.scm.azurewebsites.net/api/zipdeploy?isAsync=false")

        echo "HTTP Status Code: $HTTP_CODE"

        if [ -f deployment_response.txt ]; then
          echo "Response:"
          cat deployment_response.txt
        fi

        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 202 ]; then
          echo "Deployment completed successfully!"
          exit 0
        else
          echo "Deployment failed with HTTP code: $HTTP_CODE"
          exit 1
        fi
